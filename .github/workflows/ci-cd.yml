name: CI/CD

on:
  push:
    branches: [main, feature/**]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_image:
        description: "Container image tag to roll back to (e.g., ghcr.io/org/app:<sha>)"
        required: false

env:
  PYTHON_VERSION: "3.11"
  REGISTRY: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }} # e.g., gymmanageracrnikoloz.azurecr.io
  IMAGE_NAME: gymmanager
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests with coverage
        run: |
          pytest --cov=app --cov-report=term --cov-report=xml
          coverage report --fail-under=70
      - name: Upload coverage.xml
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.export_tag.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
      - name: Build and push image
        run: |
          docker build -t $REGISTRY/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          docker push $REGISTRY/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      - name: Export image tag
        id: export_tag
        run: echo "image_uri=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> "$GITHUB_OUTPUT"

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    environment: staging
    if: github.event_name != 'workflow_dispatch' || inputs.rollback_image == ''
    env:
      IMAGE_URI: ${{ needs.build.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Run Alembic migrations (staging)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          alembic upgrade head
      - name: Deploy to staging slot
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          slot-name: staging
          images: ${{ env.IMAGE_URI }}

  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name != 'workflow_dispatch' || inputs.rollback_image == '')
    environment: production
    env:
      IMAGE_URI: ${{ needs.build.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Run Alembic migrations (production)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          alembic upgrade head
      - name: Swap staging to production
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az webapp deployment slot swap --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --slot staging --target-slot production

  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.rollback_image != ''
    environment: production
    steps:
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Deploy specified image to staging
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          slot-name: staging
          images: ${{ inputs.rollback_image }}
      - name: Swap staging to production
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az webapp deployment slot swap --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --slot staging --target-slot production
